

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="c++" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="c++" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Xephyr basic concepts &mdash; xephyr 0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tutorials and Examples" href="tutorials.html" />
    <link rel="prev" title="Xephyr Packages" href="xephyr_packages.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> xephyr
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="xephyr_packages.html">Xephyr Packages</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Xephyr basic concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#input-handling">Input handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nuissance-parameter-handling">Nuissance Parameter Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-the-likelihood">Building the Likelihood</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-safeguard">The Safeguard</a></li>
<li class="toctree-l2"><a class="reference internal" href="#limit-setting">Limit setting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials and Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="midway.html">Setting Up on Midway2</a></li>
<li class="toctree-l1"><a class="reference internal" href="help.html">How to get Help</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">xephyr</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Xephyr basic concepts</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/basics.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="xephyr-basic-concepts">
<span id="basics"></span><h1>Xephyr basic concepts<a class="headerlink" href="#xephyr-basic-concepts" title="Permalink to this headline">¶</a></h1>
<p>In this section we describe the core component of Xephyr, we wont go trough the implementation details which is
described in the <a class="reference internal" href="tutorials.html#tutorials"><span class="std std-ref">Tutorials</span></a>, but we'll go over the concepts.</p>
<p>Xephyr core libraries can be divided into 4 different main areas, for each of them there is a c++ class or a group of classes that handle it:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#input-handling"><span class="std std-ref">Input Model/Data Handling</span></a></li>
<li><a class="reference internal" href="#nuissance"><span class="std std-ref">Nuissance Parameter Handling</span></a>, including interpolation.</li>
<li><a class="reference internal" href="#likelihood"><span class="std std-ref">Likelihood building</span></a></li>
<li><a class="reference internal" href="#limit"><span class="std std-ref">Limit setting</span></a>: with Neymann construction and asymptotics.</li>
</ul>
</div></blockquote>
<div class="section" id="input-handling">
<span id="id1"></span><h2>Input handling<a class="headerlink" href="#input-handling" title="Permalink to this headline">¶</a></h2>
<p>Currently Xephyr supports only 2D inputs (it is possible tough to use Xephyr for 1D likelihood, check out how to do it in <a class="reference external" href="https://github.com/XENON1T/Xephyr/tree/master/examples/likelihood1D">this example</a>).
The input handling is done via two classes: <a class="reference external" href="https://xenon1t.github.io/Xephyr/class_reference/classdataHandler.html">dataHandler</a>, to handle science data, toy MC and calibration and a class that handles
inputs from the models as a <a class="reference external" href="https://xenon1t.github.io/Xephyr/class_reference/classpdfComponent.html">pdfComponent</a>.</p>
<p>The <strong>dataHandler</strong> is basically just a helper class to handle ROOT Trees and is used to &quot;fill the likelihood&quot; with data points.
You can create a dataHandler in this way:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">dataHandler</span> <span class="nf">data</span><span class="p">(</span><span class="n">TString</span> <span class="n">name</span><span class="p">,</span> <span class="n">TString</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">TString</span> <span class="n">dmTree</span><span class="p">);</span>
               <span class="c1">// just a name  // ROOT file name and Tree name inside the file</span>
</pre></div>
</div>
<p>Currently the Tree must contain at least two variables (braches), the name of the branches can be set but the default is &quot;cs1&quot;, &quot;cs2&quot;.
For neymann construction, when one needs to loop over many toy datasets (where each of them is a separated Tree), one can use the dataHandler to loop
over all Tree at once using the convenient method <strong>dataHandler::setTreeIndex</strong>.</p>
<p>The <strong>pdfComponent</strong> handels instead the loading of PDF models through histograms. Again, currently this supports only <strong>TH2F</strong> as input, so you can
do 1D and 2D discriminating space with it but not more.
It is an object representing a normalized PDF, meaning that is normalized to the total expected number of events for that background or signal,
This component is designed to interplay with <a class="reference internal" href="#nuissance"><span class="std std-ref">nuissance parameter</span></a>, so that the scale (total number of events) and the shape  of the histogram can change
as a function of the parameters. The pdfComponent implements linear interpolation between any number of Shape parameters. To load models in the
form of histogram you have to follow a naming convention for the histogram, here an example:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">prefixName_parameterNameA_x</span><span class="p">.</span><span class="n">yz_parameterNameB_x</span><span class="p">.</span><span class="n">yz</span><span class="p">......</span><span class="n">_parameterNameZ_x</span><span class="p">.</span><span class="n">yz</span>
</pre></div>
</div>
<p>where the &quot;prefixName&quot; is whatever name for your bkg model, &quot;parameterName&quot; is the name of one of your parameters, and &quot;x.y.z&quot; are numbers.</p>
<p>You can find a detailed <strong>tutorial</strong> on how to use these classes for the most common cases in  <a class="reference internal" href="tutorials.html#tutorials"><span class="std std-ref">Tutorials</span></a> and you can find the official class documentation in
<a class="reference external" href="https://xenon1t.github.io/Xephyr/class_reference/classpdfComponent.html">pdfComponent</a> and <a class="reference external" href="https://xenon1t.github.io/Xephyr/class_reference/classdataHandler.html">dataHandler</a></p>
</div>
<div class="section" id="nuissance-parameter-handling">
<span id="nuissance"></span><h2>Nuissance Parameter Handling<a class="headerlink" href="#nuissance-parameter-handling" title="Permalink to this headline">¶</a></h2>
<p>Xephyr comes with two types of nuissance parameter (which in short is a fancy name to say uncertainties), a scale uncertainty, <strong>scaleSys</strong>, that takes
care of the absolute rate variation for that component, and a shape uncertainty, <strong>shapeSys</strong>, for its shape variation. We use the &quot;natural&quot; unit scale
for the uncertainties: mean zero and sigma one. Each parameter can have three different behaviours: can be just a constant <strong>fixed</strong> parameter, or
can be a <strong>free</strong> parameter, which is able to vary withouth any contraint, or can be a <strong>nuissance</strong> parameter, which can vary but is constrained by a gaussian
constrain.</p>
<p>For a <strong>shapeSys</strong> to be usable we need to load the PDF variations as a function of the parameter value, this is done loading different histogram
corresponding to specific parameters value, so one need to build a kind of grid in the parameter space, populated with histograms, which aftewards
is going to be interpolated.</p>
<p>You can find the class documentation for the paramter handling in <a class="reference external" href="https://xenon1t.github.io/Xephyr/class_reference/classshapeSys.html">shapeSys</a> and <a class="reference external" href="https://xenon1t.github.io/Xephyr/class_reference/classscaleSys.html">scaleSys</a> reference, while a detailed tutorial on how
to use them can be found in <a class="reference internal" href="tutorials.html#tutorials"><span class="std std-ref">Tutorials</span></a>.</p>
<blockquote>
<div><strong>Advanced:</strong>
Parameter that are used in combination of two likelihoods <strong>combinedParameter</strong> class. Exaplain a bit <a href="#id2"><span class="problematic" id="id3">`FIXME`_</span></a></div></blockquote>
</div>
<div class="section" id="building-the-likelihood">
<span id="likelihood"></span><h2>Building the Likelihood<a class="headerlink" href="#building-the-likelihood" title="Permalink to this headline">¶</a></h2>
<p>The likelihood classes are intended as a scaffold that collects your inputs and has the ability to run methods on them. The general idea is that a likelihood class
would be initialized with your inputs and  later on it can return the likelihood value for any parameter set. Note that the likelihood structure is predefined and
cannot be changed. There are a few types of likelihood classes and they differ based on the implementation of the likelihood function (see below),
but they all share common infrastructure like: printing parameter values and parameter access, a method called <strong>maximize</strong> that will actually minimize the -log(L),
methods computing likelihood scans, etc., you can find details on all of this in the <a class="reference internal" href="tutorials.html#tutorials"><span class="std std-ref">Tutorials</span></a> section.</p>
<blockquote>
<div><strong>IMPORTANT NOTES:</strong> the likelihood expects pdfComponents to return models normalized to number of expected events. The likelihood
rescales internally the parameter of interest (mu) to correspond to the number of &quot;observed&quot; signal events, for example, best fit mu=1.5 means
that you are &quot;fitting&quot; 1.5 signal events.</div></blockquote>
<p>Xephyr provides four types of likelihood classes:</p>
<blockquote>
<div><ul class="simple">
<li><strong>pdfLikelihood</strong>: implements the standard 2D (S1,S2) unbinned likelihood, it is composed of a poisson term that accounts for the total number of events times an
extended term that accounts for the shape, additionally each (non-free) nuissance parameter is constrained by a gaussian term.
This likelihood can be used also for a 1D PDF.</li>
</ul>
<ul class="simple">
<li><strong>binnedLikelihood</strong>: implements a binned likelihood that can be either 1D or 2D, it returns just a product of poissons computed for each bin. TH2F errors
on the bins are assigned as scale uncertainty to the bin itself.
Nowadays the trend is to go for a PDF likelihood because is &quot;more sensitive&quot;, but remember this comes with high costs, since is harder to introduce uncertainties in a
PDF shape rather than consider them as scale independent factors on bins. So this type of likelihood is handy for all those search with low rate and large unknow
uncertainties.</li>
</ul>
<ul class="simple">
<li><strong>myLikelihood</strong>: this is just an empty scheleton, it provides all the functionalities but does not implement the method <strong>computeTheLikelihood</strong>,
so the developer is free to invent his own. Note that since the input infrastructure accepts 2D only histograms this is not an easy proxy for adding
a dimension.</li>
</ul>
<ul class="simple">
<li><strong>CombinedProfileLikelihood</strong>: this class contains a list of likelihoods that need to be combined. Just add likelihood istances to its list and
use same common methods. The combination is done just by multiplying likelihood togheter, sharing the parameter of interest, it takes into account
the relative exposure using the total signal integral for each likelihood. Nuissance parameter by default are added being considered independent from
each other, if you want to correlate them then you need to use the <strong>CombinedParameter</strong> class.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="the-safeguard">
<span id="safeguard"></span><h2>The Safeguard<a class="headerlink" href="#the-safeguard" title="Permalink to this headline">¶</a></h2>
<p>The idea of the safeguard is to try to address the difficulty of assigning
uncertainty to the background model, especially when using an unbinned likelihood. This procedure needs a calibration dataset, the <strong>assumption</strong>
is that the calibration represents exactly the background component of science data that one is trying to model. The science data and the calibration data
are then simultaneously fitted, so one need to provide the calibration data to the likelihood as well, a signal component (the safeguard) is injected then
in shape of the background model and constrained by the fit on calibration. To turn On/Off the safeguard computation is quite easy,
use the <strong>setWithSafeGuard</strong> flag. Currentl Xephyr implement a positive injection of signal (default, since for a few reason can be considered more conservative), but also the possibility for a negative safeguard, that you can turn on easily using <strong>setSafeGuardPosDef(false)</strong> method.</p>
<blockquote>
<div><strong>WARNING:::</strong> The safeguard is not the holy grail and it comes with a few subtle problems. The main problem is the contamination of your calibration sample
by other background components (different from the ones you want to model). Xephyr allows you to introduce an additional background component to be
used only in the calibration fit to mimic the expected &quot;known&quot; contamination level. In case there is reason to think that the calibration sample, within the signal region,
might  suffer of uknown or largely uncertain contamination the safeguard may lead to unwanted feature, hiding a real existing signal (for positive safeguard) or
even creating a fake signal (for negative safeguard).</div></blockquote>
</div>
<div class="section" id="limit-setting">
<span id="limit"></span><h2>Limit setting<a class="headerlink" href="#limit-setting" title="Permalink to this headline">¶</a></h2>
<p>Xephyr uses the profiled likelihood approach to get rid of nuissance parameter depencency and the likelihood ratio as test statistic.
The parameter of interest (mu) is bound to be positive and the test statistic can be difined as two-sided or one-sided.
If you are unfamiliar with this we recommend to have a look for example at <a class="reference external" href="https://arxiv.org/abs/1503.07622">K. Cranmer</a> review.</p>
<blockquote>
<div></div></blockquote>
<p>Sensitivity and limits may be computed in two different way: using asymptotics formulae or Neymann construction (following Feldmann-Cousins approach).
For the asymptotics approach one can use the class <a class="reference external" href="https://xenon1t.github.io/Xephyr/class_reference/classAsymptoticExclusion.html">AsymptoticExclusion</a>, the syntax is simple (either for limit and sensitivity) and you can refer to the tutorials for this (it is basically two lines of code), while for the construction of the test statistic distribution via MC it is worth to outline the procedure here.</p>
<p><strong>Test statistic distro with MC:</strong> The goal is to compute the graph of the test statistic's 90% quantiles as a funtion of
the parameter of interest, this can be done in a following a few steps.</p>
<blockquote>
<div><ol class="arabic simple">
<li>Choose a list of parameter of interest (POI) values. Given that Xephyr is re-scaling internally the POI this list can be the same for all masses, the
recommended one is mu = [ 0.5, 1, 2, 2.5, 3, 4, 5, 10, 15 ].</li>
<li>Generate for each of the hypotheses in the list (and for each mass) MC toys datasets with nuber of signal injected events according to the hypothesis.
For a final result with reasonable precision one should target 10'000 datasets per hypothesis. The datasets can be generated using the <a class="reference external" href="https://xenon1t.github.io/Xephyr/class_reference/classToyGenerator.html">ToyGenerator</a> class,
see tutorials.</li>
<li>Each of the generated dataset must be fitted with a conditional fit mu fixed to the true generated hypothesis. Don't worry, there is a class also for this,
<a class="reference external" href="https://xenon1t.github.io/Xephyr/class_reference/classToyFitterExclusion.html">ToyFitterExclusion</a> that does it semi-automaically, you just need to feed it with a preloaded likelihood. This will loop over a set of datasets
and store their post-fit parameter values, test statistic and other in a output ROOT Tree.</li>
<li>Once You've got the post fits test statistic for all the samples (in the form of a ROOT Tree), you can extract their distribution with one of
the <strong>plotHelpers::makeQuantiles</strong>.</li>
</ol>
</div></blockquote>
<p><strong>Computing limits with MC:</strong> to compute limits for a single dataset you can use again the class <a class="reference external" href="https://xenon1t.github.io/Xephyr/class_reference/classToyFitterExclusion.html">ToyFitterExclusion</a> and its method <strong>spitTheLimit</strong>, that will take as input
the 90% quantile graph generated before. In case you want to compute sensitivity, you need compute limit for a set of null hypothesys datatets, then compute the median and
1 and 2 sigma quantiles of their distribution. For this, again, there is an helper in <strong>plotHelpers</strong>. Have a look at the <a class="reference internal" href="tutorials.html#tutorials"><span class="std std-ref">tutorials</span></a> for more info,
also you can have a look to a real life example in the  <a class="reference external" href="https://github.com/XENON1T/SR1Results/tree/master/StatisticalAnalyses/xephyr_sr1_likelihood">SR1</a> repository.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorials.html" class="btn btn-neutral float-right" title="Tutorials and Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="xephyr_packages.html" class="btn btn-neutral" title="Xephyr Packages" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Ale.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.0',
            LANGUAGE:'c++',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>